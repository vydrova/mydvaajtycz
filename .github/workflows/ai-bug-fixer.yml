name: AI Bug Fixer

on:
  repository_dispatch:
    types: [linear-ai-fix]

jobs:
  fix-bug:
    runs-on: ubuntu-latest
    env:
      BRANCH_NAME: fix/${{ github.event.client_payload.linearIssueId }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_TOKEN }}
          fetch-depth: 0  
      
      - name: Setup branch
        run: |
          git config --global user.name "AI Bug Fixer"
          git config --global user.email "ai-bug-fixer@topol.io"
          
          # Zkontroluj jestli remote branch existuje
          if git ls-remote --heads origin $BRANCH_NAME | grep -q $BRANCH_NAME; then
            echo "Branch exists, checking out..."
            git fetch origin $BRANCH_NAME
            git checkout $BRANCH_NAME
          else
            echo "Creating new branch..."
            git checkout -b $BRANCH_NAME
          fi
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code
        run: npm install -g @anthropic-ai/claude-code
      
      - name: Run Claude Code
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          claude --dangerously-skip-permissions --print "
            Bug report z Linear:
            
            Titulek: ${{ github.event.client_payload.title }}
            
            Popis: ${{ github.event.client_payload.description }}
            
            Linear Issue ID: ${{ github.event.client_payload.linearIssueId }}
            
            Najdi p≈ô√≠ƒçinu tohoto bugu v k√≥du, oprav ho. Na nic se neptej, i kdybys mƒõl dop≈àuj√≠c√≠ ot√°zky. 
            Rozhodni se v≈ædy s√°m. Udƒõlej zmƒõny a commitni je.
            NEVYTV√Å≈òEJ NOVOU BRANCH - u≈æ jsi na spr√°vn√© branch.
          "
      
      - name: Push changes
        run: |
          git push origin $BRANCH_NAME
      
      - name: Create or update Pull Request
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          # Zkontroluj jestli PR u≈æ existuje
          EXISTING_PR=$(gh pr list --head $BRANCH_NAME --json number -q '.[0].number')
          
          if [ -n "$EXISTING_PR" ]; then
            echo "PR #$EXISTING_PR already exists, updating..."
            gh pr comment $EXISTING_PR --body "ü§ñ P≈ôid√°ny nov√© zmƒõny z Claude Code"
          else
            echo "Creating new PR..."
            gh pr create \
              --head $BRANCH_NAME \
              --base master \
              --title "Fix: ${{ github.event.client_payload.title }}" \
              --body "## ü§ñ AI Bug Fix

          **Linear Issue:** ${{ github.event.client_payload.linearIssueId }}

          **Popis probl√©mu:**
          ${{ github.event.client_payload.description }}

          ---

          Tento PR byl automaticky vygenerov√°n pomoc√≠ Claude Code."
          fi
      