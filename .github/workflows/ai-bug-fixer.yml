name: Claude AI Fix from Linear

on:
  repository_dispatch:
    types: [linear-ai-fix]

permissions:
  contents: write
  pull-requests: write
  issues: write

env:
  # GitHub username kolegy pro review ‚Äî UPRAVTE
  DEFAULT_REVIEWER: "vydrova"

jobs:
  ai-fix:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      # 1. Parsov√°n√≠ dat z va≈°√≠ Lambdy
      - name: Parse Linear task data
        id: linear
        run: |
          echo "issue_id=${{ github.event.client_payload.linearIssueId }}" >> $GITHUB_OUTPUT
          echo "title=${{ github.event.client_payload.title }}" >> $GITHUB_OUTPUT

          cat <<'EOF' > /tmp/task_description.txt
          ${{ github.event.client_payload.description }}
          EOF

          # Sanitize branch name
          BRANCH_NAME="ai-fix/$(echo '${{ github.event.client_payload.title }}' | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g' | sed 's/--*/-/g' | head -c 60)"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

      # 2. Checkout
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 3. Nov√° branch
      - name: Create branch
        run: git checkout -b "${{ steps.linear.outputs.branch_name }}"

      # 4. Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      # 5. Claude Code
      - name: Install Claude Code
        run: npm install -g @anthropic-ai/claude-code

      # 6. Spu≈°tƒõn√≠ Clauda
      - name: Run Claude Code
        id: claude
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          TASK_DESC=$(cat /tmp/task_description.txt)

          claude -p "Vy≈ôe≈° n√°sleduj√≠c√≠ √∫kol z Linear issue ${{ steps.linear.outputs.issue_id }}:

          ## N√°zev
          ${{ steps.linear.outputs.title }}

          ## Popis
          $TASK_DESC

          ## Instrukce
          1. Analyzuj probl√©m a najdi relevantn√≠ soubory v projektu
          2. Implementuj opravu nebo vylep≈°en√≠
          3. Ujisti se, ≈æe k√≥d je spr√°vnƒõ naform√°tovan√Ω
          4. Pokud existuj√≠ testy, spus≈• je
          5. Pokud si nejsi jist√Ω, p≈ôidej koment√°≈ô // TODO: verify
          6. Soust≈ôeƒè se pouze na popsan√Ω probl√©m, nemƒõ≈à nic nav√≠c" \
            --allowedTools "Read,Write,Edit,Bash(npm run lint:*),Bash(npm run test:*),Bash(npm test),Bash(npx tsc --noEmit),Bash(git diff:*),Bash(git status),Bash(find:*),Bash(grep:*),Bash(cat:*)" \
            --max-turns 30 \
            --output-format text \
            > /tmp/claude_output.txt 2>&1 || true

          if git diff --quiet && git diff --cached --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      # 7. Commit a push
      - name: Commit and push
        if: steps.claude.outputs.has_changes == 'true'
        run: |
          git config user.name "Claude AI Fix"
          git config user.email "claude-ai-fix@noreply.github.com"
          git add -A
          git commit -m "ai-fix: ${{ steps.linear.outputs.title }}

          Linear issue: ${{ steps.linear.outputs.issue_id }}
          Automaticky vygenerov√°no Claude Code."
          git push --force-with-lease origin "${{ steps.linear.outputs.branch_name }}"

      # 8. PR s labelem a reviewerem
      - name: Create Pull Request
        if: steps.claude.outputs.has_changes == 'true'
        id: create_pr
        uses: actions/github-script@v7
        with:
          script: |
            const claudeOutput = require('fs').readFileSync('/tmp/claude_output.txt', 'utf8').substring(0, 3000);

            const pr = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[AI Fix] ${{ steps.linear.outputs.title }}`,
              body: [
                '## Automatick√° oprava z Linear issue',
                '',
                '**Linear issue ID:** `${{ steps.linear.outputs.issue_id }}`',
                '',
                '### Co Claude udƒõlal',
                '```',
                claudeOutput,
                '```',
                '',
                '---',
                '‚ö†Ô∏è **Toto PR bylo vygenerov√°no automaticky.** Pros√≠m peƒçlivƒõ zkontrolujte zmƒõny.'
              ].join('\n'),
              head: '${{ steps.linear.outputs.branch_name }}',
              base: 'master'
            });

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.data.number,
              labels: ['ai-fix', 'testing-preview']
            });

            try {
              await github.rest.pulls.requestReviewers({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.data.number,
                reviewers: ['${{ env.DEFAULT_REVIEWER }}']
              });
            } catch (e) {
              console.log('Reviewer assignment failed:', e.message);
            }

            core.setOutput('pr_url', pr.data.html_url);

      # 9. Koment√°≈ô zpƒõt do Linearu (voliteln√©)
      - name: Comment on Linear task
        if: always()
        env:
          LINEAR_API_KEY: ${{ secrets.LINEAR_API_KEY }}
        run: |
          if [ -z "$LINEAR_API_KEY" ]; then
            echo "LINEAR_API_KEY not set, skipping"
            exit 0
          fi

          if [ "${{ steps.claude.outputs.has_changes }}" == "true" ]; then
            MSG="ü§ñ **Claude AI Fix** vytvo≈ôil PR: ${{ steps.create_pr.outputs.pr_url }}\n\nƒåek√° na code review."
          else
            OUTPUT=$(head -c 1500 /tmp/claude_output.txt | sed 's/"/\\"/g' | tr '\n' ' ')
            MSG="‚ö†Ô∏è **Claude AI Fix** nedok√°zal prov√©st zmƒõny.\n\n\`\`\`\n${OUTPUT}\n\`\`\`\n\nTask vy≈æaduje manu√°ln√≠ ≈ôe≈°en√≠."
          fi

          curl -s -X POST https://api.linear.app/graphql \
            -H "Content-Type: application/json" \
            -H "Authorization: $LINEAR_API_KEY" \
            -d "{
              \"query\": \"mutation(\$id: String!, \$body: String!) { commentCreate(input: { issueId: \$id, body: \$body }) { success } }\",
              \"variables\": {
                \"id\": \"${{ steps.linear.outputs.issue_id }}\",
                \"body\": \"$MSG\"
              }
            }"
